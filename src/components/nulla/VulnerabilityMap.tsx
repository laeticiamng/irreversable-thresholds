import { useNavigate } from 'react-router-dom';
import { Absence } from '@/types/database';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import { ExternalLink } from 'lucide-react';

const CATEGORY_LABELS: Record<string, string> = {
  ressource: 'Ressource',
  preuve: 'Preuve / Document',
  acces: 'Accès',
  competence: 'Compétence',
  protection: 'Protection',
  information: 'Information',
  relation: 'Relation / Soutien',
  stabilite: 'Stabilité',
  autre: 'Autre',
};

const CATEGORY_DESCRIPTIONS: Record<string, string> = {
  ressource: 'Ce qui manque pour agir (argent, temps, outils)',
  preuve: 'Documents ou preuves manquants',
  acces: 'Accès manquants (infrastructure, service)',
  competence: 'Compétences manquantes dans l\'équipe',
  protection: 'Protections ou filets de sécurité absents',
  information: 'Informations manquantes ou peu fiables',
  relation: 'Soutien ou relations clés manquants',
  stabilite: 'Manque de stabilité ou continuité',
  autre: 'Autres types d\'absences',
};

interface VulnerabilityMapProps {
  absences: Absence[];
}

export function VulnerabilityMap({ absences }: VulnerabilityMapProps) {
  const navigate = useNavigate();

  const handleAbsenceClick = (absence: Absence) => {
    if (absence.case_id) {
      navigate(`/nulla/cases/${absence.case_id}`);
    }
  };

  // Group absences by category
  const byCategory = absences.reduce((acc, absence) => {
    const category = (absence as any).category || 'autre';
    if (!acc[category]) acc[category] = [];
    acc[category].push(absence);
    return acc;
  }, {} as Record<string, Absence[]>);

  // Get critical absences (high impact)
  const criticalAbsences = absences.filter(a => (a as any).impact_level === 'high');

  // Sort categories by count
  const sortedCategories = Object.entries(byCategory)
    .sort(([, a], [, b]) => b.length - a.length);

  // Find dominant categories
  const dominantCategories = sortedCategories
    .filter(([, abs]) => abs.length >= 2)
    .slice(0, 3);

  return (
    <div className="space-y-8">
      {/* Critical section */}
      {criticalAbsences.length > 0 && (
        <div className="p-6 border-2 border-red-500/30 bg-red-500/5">
          <div className="flex items-center gap-3 mb-4">
            <span className="text-2xl">⚠️</span>
            <h3 className="font-display text-xl text-red-500">
              Vulnérabilités critiques
            </h3>
            <span className="ml-auto text-2xl font-display text-red-500">
              {criticalAbsences.length}
            </span>
          </div>
          <div className="space-y-3">
            {criticalAbsences.map(absence => (
              <div 
                key={absence.id}
                onClick={() => handleAbsenceClick(absence)}
                className={`p-4 bg-background/80 border border-red-500/20 ${absence.case_id ? 'cursor-pointer hover:bg-background transition-colors' : ''}`}
              >
                <div className="flex items-start gap-3">
                  <span className="text-red-500 mt-1">●</span>
                  <div className="flex-1">
                    <h4 className="font-medium text-foreground">{absence.title}</h4>
                    {absence.effects && absence.effects.length > 0 && (
                      <p className="text-sm text-muted-foreground mt-1">
                        → {absence.effects[0].description}
                      </p>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs px-2 py-0.5 bg-red-500/10 text-red-500">
                      {CATEGORY_LABELS[(absence as any).category || 'autre']}
                    </span>
                    {absence.case_id && <ExternalLink className="w-3 h-3 text-red-500/50" />}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Dominant categories summary */}
      {dominantCategories.length > 0 && (
        <div className="grid md:grid-cols-3 gap-4">
          {dominantCategories.map(([category, abs]) => {
            const highCount = abs.filter(a => (a as any).impact_level === 'high').length;
            return (
              <div 
                key={category}
                className="p-4 border border-nulla/20 bg-nulla/5 text-center"
              >
                <span className="text-3xl font-display text-nulla">{abs.length}</span>
                <h4 className="font-display text-sm text-foreground mt-2">
                  {CATEGORY_LABELS[category]}
                </h4>
                {highCount > 0 && (
                  <p className="text-xs text-red-500 mt-1">
                    dont {highCount} critique{highCount > 1 ? 's' : ''}
                  </p>
                )}
              </div>
            );
          })}
        </div>
      )}

      {/* Categories accordion */}
      <Accordion type="multiple" className="space-y-2">
        {sortedCategories.map(([category, categoryAbsences]) => {
          const highCount = categoryAbsences.filter(a => (a as any).impact_level === 'high').length;
          
          return (
            <AccordionItem 
              key={category} 
              value={category}
              className="border border-nulla/20 bg-card/30"
            >
              <AccordionTrigger className="px-6 hover:no-underline hover:bg-nulla/5">
                <div className="flex items-center gap-4 text-left">
                  <span className="text-2xl font-display text-nulla">
                    {categoryAbsences.length}
                  </span>
                  <div>
                    <h3 className="font-display text-foreground">
                      {CATEGORY_LABELS[category]}
                    </h3>
                    <p className="text-xs text-muted-foreground font-normal">
                      {CATEGORY_DESCRIPTIONS[category]}
                    </p>
                  </div>
                  {highCount > 0 && (
                    <span className="ml-auto mr-4 text-xs px-2 py-0.5 bg-red-500/10 text-red-500">
                      {highCount} critique{highCount > 1 ? 's' : ''}
                    </span>
                  )}
                </div>
              </AccordionTrigger>
              <AccordionContent className="px-6 pb-4">
                <div className="space-y-2 pt-2">
                  {categoryAbsences.map(absence => {
                    const impact = (absence as any).impact_level || 'moderate';
                    const impactColors = {
                      high: 'text-red-500',
                      moderate: 'text-amber-500',
                      low: 'text-green-500',
                    };
                    
                    return (
                      <div 
                        key={absence.id}
                        onClick={() => handleAbsenceClick(absence)}
                        className={`p-3 bg-background/50 border border-border/30 ${absence.case_id ? 'cursor-pointer hover:bg-background/80 transition-colors' : ''}`}
                      >
                        <div className="flex items-start gap-3">
                          <span className={`mt-1 ${impactColors[impact as keyof typeof impactColors]}`}>●</span>
                          <div className="flex-1">
                            <span className="text-foreground">{absence.title}</span>
                            {absence.effects && absence.effects.length > 0 && (
                              <p className="text-sm text-muted-foreground mt-1">
                                → {absence.effects[0].description}
                              </p>
                            )}
                          </div>
                          {absence.case_id && <ExternalLink className="w-3 h-3 text-muted-foreground" />}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </AccordionContent>
            </AccordionItem>
          );
        })}
      </Accordion>

      {/* Empty state */}
      {absences.length === 0 && (
        <div className="text-center py-16 border border-dashed border-nulla/20">
          <div className="text-4xl text-nulla/40 mb-4">∅</div>
          <p className="text-muted-foreground">Aucune absence à cartographier.</p>
        </div>
      )}
    </div>
  );
}
